<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ± - Ù…Ø·Ø¨Ø¹Ø© Ø·Ø§Ø±Ù‚ Ø£Ø¨ÙˆÙ‡Ù…Ø§Ù…</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      background: #eef3f7;
      padding: 20px;
      margin: 0;
      font-size: 17px;
    }
    h1, h2, h3 {
      color: #0d3b66;
      margin: 0 0 10px;
    }
    .section {
      background: #ffffff;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 20px;
      width: 100%;
    }
    input, button, select, table {
      font-family: 'Tajawal', sans-serif;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 10px 15px;
      margin: 5px 5px 5px 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      transition: background 0.3s ease;
    }
    .add-btn { background: #0077b6; }
    .add-btn:hover { background: #005f87; }
    .collect-btn { background: #2a9d8f; }
    .collect-btn:hover { background: #1e7d6b; }
    .print-btn { background: #f4a261; }
    .print-btn:hover { background: #e07b33; }
    .delete-btn { background: crimson; }
    .delete-btn:hover { background: #a30000; }
    .edit-btn { background: orange; }
    .edit-btn:hover { background: #cc8400; }
    .export-btn { background: #6b7280; }
    .export-btn:hover { background: #4b5563; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: right;
    }
    th {
      background: #0d3b66;
      color: white;
    }
    .summary {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-top: 10px;
      gap: 10px;
    }
    .summary div {
      background: #ffffff;
      padding: 10px;
      border-radius: 6px;
      flex: 1 1 120px;
      text-align: center;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 95%;
      max-width: 400px;
    }
    .hidden-print { display: none; }
    .login-screen {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: linear-gradient(135deg, #0d3b66, #0077b6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    .login-box {
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .login-logo {
      width: 300px;
      height: auto;
      margin-bottom: 30px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .login-box h2 {
      color: #0d3b66;
      font-size: 24px;
      margin-bottom: 20px;
      font-weight: 700;
    }
    .input-group {
      margin-bottom: 20px;
      text-align: right;
    }
    .input-group label {
      display: block;
      color: #0d3b66;
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 700;
    }
    .input-group i {
      margin-left: 8px;
      color: #0077b6;
    }
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    .input-group input:focus {
      outline: none;
      border-color: #0077b6;
      box-shadow: 0 0 5px rgba(0, 119, 182, 0.3);
    }
    .login-btn {
      background: #0077b6;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .login-btn:hover {
      background: #005f87;
      transform: translateY(-2px);
    }
    .login-btn i {
      margin-left: 8px;
    }
    .login-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(to right, #f4a261, #0077b6);
      border-radius: 15px 15px 0 0;
    }
    @media (max-width: 600px) {
      table {
        display: block;
        overflow-x: auto;
      }
      th, td {
        white-space: nowrap;
      }
      .summary {
        flex-direction: column;
        align-items: stretch;
      }
      .login-box {
        padding: 20px;
        width: 95%;
      }
      .login-logo {
        width: 100px;
      }
      .login-box h2 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <img src="https://i.servimg.com/u/f28/15/53/23/87/ae_a_010.jpg" alt="Ù„ÙˆØ¬Ùˆ Ù…Ø·Ø¨Ø¹Ø© Ø·Ø§Ø±Ù‚ Ø£Ø¨ÙˆÙ‡Ù…Ø§Ù…" class="login-logo" />
      <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ù…Ø·Ø¨Ø¹Ø© Ø·Ø§Ø±Ù‚ Ø£Ø¨ÙˆÙ‡Ù…Ø§Ù…</h2>
      <div class="input-group">
        <label><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
        <input id="username" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
      </div>
      <div class="input-group">
        <label><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
        <input id="password" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      </div>
      <button onclick="login()" class="login-btn"><i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <h1>Ù…Ø·Ø¨Ø¹Ø© Ø·Ø§Ø±Ù‚ Ø£Ø¨ÙˆÙ‡Ù…Ø§Ù… - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±</h1>
  <div class="section">
    <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©</h2>
    <div class="summary" id="generalStats"></div>
  </div>
  <div class="section">
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <button onclick="exportData()" class="export-btn"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <input type="file" id="importData" accept=".json" onchange="importData(event)" style="display: inline-block; width: auto;" />
  </div>
  <div class="section">
    <h2>Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</h2>
    <input oninput="renderCustomers()" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." id="searchBox" type="text" />
  </div>
  <div class="section">
    <h2>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
    <input id="customerName" type="text" />
    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
    <input id="customerPhone" type="text" />
    <button onclick="addCustomer()" class="add-btn"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
  </div>
  <div class="section">
    <h2>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
    <div id="customersContainer"></div>
  </div>

  <div class="modal" id="invoiceModal">
    <div class="modal-content">
      <h3>Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø±</h3>
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</label>
      <select id="bannerType">
        <option value="Ø¨Ù†Ø±">Ø¨Ù†Ø±</option>
        <option value="ÙÙ„ÙŠÙƒØ³">ÙÙ„ÙŠÙƒØ³</option>
        <option value="ÙÙŠÙ†ÙŠÙ„">ÙÙŠÙ†ÙŠÙ„</option>
      </select>
      <label>Ø§Ù„Ø¹Ø±Ø¶ (Ù…ØªØ±):</label>
      <input type="number" id="bannerWidth" min="0" step="0.01" />
      <label>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±):</label>
      <input type="number" id="bannerHeight" min="0" step="0.01" />
      <label>Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ±:</label>
      <input type="number" id="bannerPrice" min="0" step="0.01" />
      <button onclick="saveBannerInvoice()" class="add-btn"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
      <button onclick="closeModal()" class="delete-btn"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <div class="modal" id="genericInvoiceModal">
    <div class="modal-content">
      <h3>Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¹Ø§Ù…Ø©</h3>
      <label>Ø§Ù„ÙˆØµÙ:</label>
      <input type="text" id="descInput" />
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
      <input type="number" id="qtyInput" min="1" />
      <label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
      <input type="number" id="unitPriceInput" min="0" step="0.01" />
      <button onclick="saveGenericInvoice()" class="add-btn"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
      <button onclick="closeGenericModal()" class="delete-btn"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
  <div class="hidden-print" id="invoicePrint"></div>

  <script>
    let firebaseInitialized = false;
    let customersRef = null;
    let currentUser = null;

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    if (typeof firebase !== 'undefined') {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyBUhkNuW4HmYe7YtErEYALrsnc7dOhXxRk",
          authDomain: "tarek0.firebaseapp.com",
          databaseURL: "https://tarek0-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "tarek0",
          storageBucket: "tarek0.firebasestorage.app",
          messagingSenderId: "401049849658",
          appId: "1:401049849658:web:16ba28dd7fee3b8f20ca03",
          measurementId: "G-38CV51MHB6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        customersRef = database.ref('customers');
        firebaseInitialized = true;
        showToast("ğŸ”¥ Ù†Ø¸Ø§Ù… ÙÙˆØ§ØªÙŠØ± Ø·Ø§Ø±Ù‚ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù€ Firebase ğŸ”¥", "success");
      } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", e);
        showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: " + e.message, "error");
      }
    } else {
      console.error("Firebase ØºÙŠØ± Ù…ØªØ§Ø­");
      showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: Ù…ÙƒØªØ¨Ø© Firebase Ù„Ù… ØªØªØ­Ù…Ù„", "error");
    }

    let data = firebaseInitialized ? [] : JSON.parse(localStorage.getItem("customersData") || "[]");
    let currentCustomerIndex = null;
    let operationCount = 0;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (firebaseInitialized) {
      customersRef.on('value', (snapshot) => {
        data = snapshot.val() || [];
        renderCustomers();
        renderGeneralStats();
      }, (error) => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        showToast("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase. ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage.", "error");
        data = JSON.parse(localStorage.getItem("customersData") || "[]");
        renderCustomers();
        renderGeneralStats();
      });
    } else {
      renderCustomers();
      renderGeneralStats();
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function saveData() {
      if (firebaseInitialized) {
        customersRef.set(data)
          .then(() => {
            console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase");
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "success");
          })
          .catch((error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
            localStorage.setItem("customersData", JSON.stringify(data));
            showToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase. ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§.", "error");
          });
      } else {
        localStorage.setItem("customersData", JSON.stringify(data));
        showToast("Firebase ØºÙŠØ± Ù…ØªØ§Ø­. ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§.", "error");
      }
      operationCount++;
      if (operationCount % 10 === 0) {
        if (confirm("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ù€ 10 Ø¹Ù…Ù„ÙŠØ§Øª! Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§ØŸ")) {
          exportData();
        }
      }
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±
    function showToast(message, type = 'success') {
      if (typeof Toastify !== 'undefined') {
        Toastify({
          text: message,
          duration: 3000,
          gravity: "top",
          position: "right",
          style: { background: type === 'success' ? '#2a9d8f' : '#dc2626' }
        }).showToast();
      } else {
        console.log("Toastify ØºÙŠØ± Ù…ØªØ§Ø­:", message);
      }
    }

    // ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
    window.onbeforeunload = function() {
      if (data.length > 0) {
        return "Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø®Ø§Ø±Ø¬ÙŠÙ‹Ø§. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµØ¯ÙŠØ±Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ";
      }
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Authentication
    function login() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value;
      if (!user || !pass) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "error");
        return;
      }
      firebase.auth().signInWithEmailAndPassword(user + "@example.com", pass)
        .then((userCredential) => {
          currentUser = userCredential.user;
          document.getElementById("loginScreen").style.display = "none";
          showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­", "success");
        })
        .catch((error) => {
          showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©: " + error.message, "error");
        });
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
    function addCustomer() {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      const name = document.getElementById("customerName").value.trim();
      const phone = document.getElementById("customerPhone").value.trim();
      if (!name || !phone) return showToast("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "error");
      const newCustomer = { name, phone, invoices: [] };
      if (firebaseInitialized) {
        customersRef.push(newCustomer)
          .then(() => {
            document.getElementById("customerName").value = "";
            document.getElementById("customerPhone").value = "";
            showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
          })
          .catch((error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„:", error);
            data.push(newCustomer);
            saveData();
            renderCustomers();
            showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Firebase.", "error");
          });
      } else {
        data.push(newCustomer);
        saveData();
        renderCustomers();
        showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
      }
    }

    // Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©
    function addInvoice(index) {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      currentCustomerIndex = index;
      const isBanner = confirm("Ù‡Ù„ Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø± / ÙÙ„ÙŠÙƒØ³ / ÙÙŠÙ†ÙŠÙ„ØŸ");
      if (isBanner) {
        document.getElementById("invoiceModal").style.display = "flex";
      } else {
        document.getElementById("genericInvoiceModal").style.display = "flex";
      }
    }

    // Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø±
    function saveBannerInvoice() {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      const type = document.getElementById("bannerType").value;
      const w = Number(document.getElementById("bannerWidth").value);
      const h = Number(document.getElementById("bannerHeight").value);
      const unitPrice = Number(document.getElementById("bannerPrice").value);
      if (isNaN(w) || w <= 0 || isNaN(h) || h <= 0 || isNaN(unitPrice) || unitPrice <= 0) {
        return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø©", "error");
      }
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨Ù†Ø±ØŸ")) return;
      const description = `${type} ${w}Ã—${h}`;
      const quantity = w * h;
      const total = quantity * unitPrice;
      const invoice = { description, quantity, unitPrice, total, paid: 0, remaining: total, date: new Date().toLocaleString("ar-EG") };
      if (firebaseInitialized) {
        const customerKeys = Object.keys(data);
        customersRef.child(customerKeys[currentCustomerIndex]).child('invoices').push(invoice)
          .then(() => {
            closeModal();
            showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨Ù†Ø± Ø¨Ù†Ø¬Ø§Ø­");
          })
          .catch((error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", error);
            data[currentCustomerIndex].invoices.push(invoice);
            saveData();
            renderCustomers();
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Firebase.", "error");
          });
      } else {
        data[currentCustomerIndex].invoices.push(invoice);
        saveData();
        closeModal();
        renderCustomers();
        showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨Ù†Ø± Ø¨Ù†Ø¬Ø§Ø­");
      }
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨Ù†Ø±
    function closeModal() {
      document.getElementById("invoiceModal").style.display = "none";
      document.getElementById("bannerType").value = "Ø¨Ù†Ø±";
      document.getElementById("bannerWidth").value = "";
      document.getElementById("bannerHeight").value = "";
      document.getElementById("bannerPrice").value = "";
    }

    // Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø¹Ø§Ù…Ø©
    function saveGenericInvoice() {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      const description = document.getElementById("descInput").value.trim();
      const quantity = Number(document.getElementById("qtyInput").value);
      const unitPrice = Number(document.getElementById("unitPriceInput").value);
      if (!description || isNaN(quantity) || quantity <= 0 || isNaN(unitPrice) || unitPrice <= 0) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø©", "error");
        return;
      }
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©ØŸ")) return;
      const total = quantity * unitPrice;
      const invoice = { description, quantity, unitPrice, total, paid: 0, remaining: total, date: new Date().toLocaleString("ar-EG") };
      if (firebaseInitialized) {
        const customerKeys = Object.keys(data);
        customersRef.child(customerKeys[currentCustomerIndex]).child('invoices').push(invoice)
          .then(() => {
            closeGenericModal();
            showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­");
          })
          .catch((error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", error);
            data[currentCustomerIndex].invoices.push(invoice);
            saveData();
            renderCustomers();
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Firebase.", "error");
          });
      } else {
        data[currentCustomerIndex].invoices.push(invoice);
        saveData();
        closeGenericModal();
        renderCustomers();
        showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­");
      }
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    function closeGenericModal() {
      document.getElementById("genericInvoiceModal").style.display = "none";
      document.getElementById("descInput").value = "";
      document.getElementById("qtyInput").value = "";
      document.getElementById("unitPriceInput").value = "";
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    function renderCustomers() {
      const sc = document.getElementById("searchBox").value.toLowerCase();
      const cont = document.getElementById("customersContainer");
      cont.innerHTML = "";
      if (firebaseInitialized) {
        const customerKeys = Object.keys(data);
        customerKeys.forEach((key, i) => {
          const cust = data[key];
          if (!cust.name.toLowerCase().includes(sc)) return;
          const filtered = cust.invoices ? cust.invoices.filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„") : [];
          const tot = filtered.reduce((s, inv) => s + (inv.total || 0), 0);
          const paid = filtered.reduce((s, inv) => s + (inv.paid || 0), 0);
          const rem = tot - paid;
          const div = document.createElement("div");
          div.className = "section";
          const rows = (cust.invoices || []).map((inv, j) => `
            <tr>
              <td>${inv.date || ''}</td><td>${inv.description || ''}</td><td>${inv.quantity || 0}</td>
              <td>${inv.unitPrice || 0}</td><td>${inv.total || 0}</td><td>${inv.paid || 0}</td><td>${inv.remaining || 0}</td>
              <td><button class="delete-btn" onclick="deleteInvoice('${key}', ${j})"><i class="fas fa-trash"></i> Ø­Ø°Ù</button></td>
            </tr>`).join('');
          div.innerHTML = `
            <h3>${cust.name} - ${cust.phone}
              <button class="edit-btn" onclick="editCustomer('${key}')"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteCustomer('${key}')"><i class="fas fa-trash"></i></button>
            </h3>
            <button class="add-btn" onclick="addInvoice(${i})"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©</button>
            <button class="collect-btn" onclick="collectPayment('${key}')"><i class="fas fa-money-bill"></i> ØªØ­ØµÙŠÙ„</button>
            <button class="print-btn" onclick="exportCustomerOnly('${key}')"><i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± PDF</button>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${tot} | <strong>Ù…Ø¯ÙÙˆØ¹:</strong> ${paid} | <strong>Ù…ØªØ¨Ù‚ÙŠ:</strong> ${rem}</p>
            <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø­Ø°Ù</th></tr></thead><tbody>${rows}</tbody></table>
            <div class="summary">
              <div><i class="fas fa-coins"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${tot}</div>
              <div><i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${paid}</div>
              <div><i class="fas fa-hourglass-half"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${rem}</div>
            </div>`;
          cont.appendChild(div);
        });
      } else {
        data.forEach((cust, i) => {
          if (!cust.name.toLowerCase().includes(sc)) return;
          const filtered = cust.invoices.filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„");
          const tot = filtered.reduce((s, inv) => s + inv.total, 0);
          const paid = filtered.reduce((s, inv) => s + inv.paid, 0);
          const rem = tot - paid;
          const div = document.createElement("div");
          div.className = "section";
          const rows = cust.invoices.map((inv, j) => `
            <tr>
              <td>${inv.date}</td><td>${inv.description}</td><td>${inv.quantity}</td>
              <td>${inv.unitPrice}</td><td>${inv.total}</td><td>${inv.paid}</td><td>${inv.remaining}</td>
              <td><button class="delete-btn" onclick="deleteInvoiceLocal(${i}, ${j})"><i class="fas fa-trash"></i> Ø­Ø°Ù</button></td>
            </tr>`).join('');
          div.innerHTML = `
            <h3>${cust.name} - ${cust.phone}
              <button class="edit-btn" onclick="editCustomerLocal(${i})"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteCustomerLocal(${i})"><i class="fas fa-trash"></i></button>
            </h3>
            <button class="add-btn" onclick="addInvoice(${i})"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©</button>
            <button class="collect-btn" onclick="collectPaymentLocal(${i})"><i class="fas fa-money-bill"></i> ØªØ­ØµÙŠÙ„</button>
            <button class="print-btn" onclick="exportCustomerOnlyLocal(${i})"><i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± PDF</button>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${tot} | <strong>Ù…Ø¯ÙÙˆØ¹:</strong> ${paid} | <strong>Ù…ØªØ¨Ù‚ÙŠ:</strong> ${rem}</p>
            <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø­Ø°Ù</th></tr></thead><tbody>${rows}</tbody></table>
            <div class="summary">
              <div><i class="fas fa-coins"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${tot}</div>
              <div><i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${paid}</div>
              <div><i class="fas fa-hourglass-half"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${rem}</div>
            </div>`;
          cont.appendChild(div);
        });
      }
    }

    // Ø­Ø°Ù Ø¹Ù…ÙŠÙ„ (Firebase)
    function deleteCustomer(key) {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      if (!firebaseInitialized) {
        showToast("Firebase ØºÙŠØ± Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… deleteCustomerLocal.", "error");
        return;
      }
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ${data[key].name}ØŸ`)) return;
      const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:");
      if (pass === "1234") {
        customersRef.child(key).remove()
          .then(() => showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­"))
          .catch((error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
            showToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Firebase. Ø¬Ø±Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§.", "error");
          });
      } else {
        showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©", "error");
      }
    }

    // Ø­Ø°Ù Ø¹Ù…ÙŠÙ„ (Ù…Ø­Ù„ÙŠ)
    function deleteCustomerLocal(index) {
      if (firebaseInitialized) {
        showToast("Firebase Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… deleteCustomer.", "error");
        return;
      }
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ${data[index].name}ØŸ`)) return;
      const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:");
      if (pass === "1234") {
        data.splice(index, 1);
        saveData();
        renderCustomers();
        showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
      } else {
        showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©", "error");
      }
    }

    // Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© (Firebase)
    function deleteInvoice(custKey, invIndex) {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      if (!firebaseInitialized) {
        showToast("Firebase ØºÙŠØ± Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… deleteInvoiceLocal.", "error");
        return;
      }
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ`)) return;
      const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:");
      if (pass === "1234") {
        const invoicesRef = customersRef.child(custKey).child('invoices');
        const invoiceKeys = Object.keys(data[custKey].invoices || {});
        invoicesRef.child(invoiceKeys[invIndex]).remove()
          .then(() => showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­"))
          .catch((error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
            showToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Firebase. Ø¬Ø±Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§.", "error");
          });
      } else {
        showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©", "error");
      }
    }

    // Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© (Ù…Ø­Ù„ÙŠ)
    function deleteInvoiceLocal(custIndex, invIndex) {
      if (firebaseInitialized) {
        showToast("Firebase Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… deleteInvoice.", "error");
        return;
      }
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ`)) return;
      const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:");
      if (pass === "1234") {
        data[custIndex].invoices.splice(invIndex, 1);
        saveData();
        renderCustomers();
        showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
      } else {
        showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©", "error");
      }
    }

    // ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© (Firebase)
    function collectPayment(key) {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      if (!firebaseInitialized) {
        showToast("Firebase ØºÙŠØ± Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… collectPaymentLocal.", "error");
        return;
      }
      const customer = data[key];
      const remaining = (customer.invoices || []).filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„").reduce((s, inv) => s + (inv.remaining || 0), 0);
      const amount = Number(prompt(`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining}\nØ£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº:`));
      if (isNaN(amount) || amount <= 0) return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ ÙˆÙ…ÙˆØ¬Ø¨", "error");
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº ${amount}ØŸ`)) return;
      const paymentInvoice = {
        description: "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„",
        quantity: 1,
        unitPrice: amount,
        total: amount,
        paid: amount,
        remaining: 0,
        date: new Date().toLocaleString("ar-EG")
      };
      customersRef.child(key).child('invoices').push(paymentInvoice);
      let toPay = amount;
      for (let inv of (customer.invoices || [])) {
        if (inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„" && (inv.remaining || 0) > 0 && toPay > 0) {
          const pay = Math.min(inv.remaining, toPay);
          inv.paid = (inv.paid || 0) + pay;
          inv.remaining = (inv.remaining || 0) - pay;
          toPay -= pay;
        }
      }
      customersRef.child(key).child('invoices').set(customer.invoices || [])
        .then(() => showToast("ØªÙ… ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­"))
        .catch((error) => {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„:", error);
          showToast("ÙØ´Ù„ Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ù† Firebase. Ø¬Ø±Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§.", "error");
        });
    }

    // ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© (Ù…Ø­Ù„ÙŠ)
    function collectPaymentLocal(index) {
      if (firebaseInitialized) {
        showToast("Firebase Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… collectPayment.", "error");
        return;
      }
      const customer = data[index];
      const remaining = customer.invoices.filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„").reduce((s, inv) => s + inv.remaining, 0);
      const amount = Number(prompt(`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining}\nØ£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº:`));
      if (isNaN(amount) || amount <= 0) return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ ÙˆÙ…ÙˆØ¬Ø¨", "error");
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº ${amount}ØŸ`)) return;
      const paymentInvoice = {
        description: "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„",
        quantity: 1,
        unitPrice: amount,
        total: amount,
        paid: amount,
        remaining: 0,
        date: new Date().toLocaleString("ar-EG")
      };
      customer.invoices.push(paymentInvoice);
      let toPay = amount;
      for (let inv of customer.invoices) {
        if (inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„" && inv.remaining > 0 && toPay > 0) {
          const pay = Math.min(inv.remaining, toPay);
          inv.paid += pay;
          inv.remaining -= pay;
          toPay -= pay;
        }
      }
      saveData();
      renderCustomers();
      showToast("ØªÙ… ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­");
    }

    // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙƒÙ€ PDF (Firebase)
    function exportCustomerOnly(key) {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      const cust = data[key];
      const filtered = (cust.invoices || []).filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„");
      const tot = filtered.reduce((s, inv) => s + (inv.total || 0), 0);
      const paid = filtered.reduce((s, inv) => s + (inv.paid || 0), 0);
      const rem = tot - paid;
      const rows = (cust.invoices || []).map(inv => `
        <tr>
          <td>${inv.date || ''}</td><td>${inv.description || ''}</td><td>${inv.quantity || 0}</td>
          <td>${inv.unitPrice || 0}</td><td>${inv.total || 0}</td><td>${inv.paid || 0}</td><td>${inv.remaining || 0}</td>
        </tr>`).join('');
      let html = `
        <div style="font-family: 'Tajawal'; padding:20px; direction:rtl;">
          <h2 style="text-align:center;">Ù…Ø·Ø¨Ø¹Ø© Ø·Ø§Ø±Ù‚ Ø£Ø¨ÙˆÙ‡Ù…Ø§Ù…</h2>
          <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
          <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${cust.name}</p>
          <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${cust.phone}</p>
          <h3>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
          <table style="width:100%; border-collapse:collapse; border:1px solid #ccc;">
            <thead><tr style="background:#0d3b66; color:white;">
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ù…ØªØ¨Ù‚ÙŠ</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <div style="margin-top:20px;">
            <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${tot}</p>
            <p><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paid}</p>
            <p><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${rem}</p>
          </div>
        </div>
      `;
      document.getElementById("invoicePrint").innerHTML = html;
      setTimeout(() => {
        if (typeof html2pdf !== 'undefined') {
          html2pdf().from(document.getElementById("invoicePrint")).set({
            margin: 0.5,
            jsPDF: { format: 'a4' }
          }).save(`ÙÙˆØ§ØªÙŠØ±-${cust.name}.pdf`);
        } else {
          showToast("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ PDF.", "error");
        }
      }, 300);
      showToast("ØªÙ… ØªØµØ¯ÙŠØ± PDF Ø¨Ù†Ø¬Ø§Ø­");
    }

    // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙƒÙ€ PDF (Ù…Ø­Ù„ÙŠ)
    function exportCustomerOnlyLocal(index) {
      if (firebaseInitialized) {
        showToast("Firebase Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… exportCustomerOnly.", "error");
        return;
      }
      const cust = data[index];
      const filtered = cust.invoices.filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„");
      const tot = filtered.reduce((s, inv) => s + inv.total, 0);
      const paid = filtered.reduce((s, inv) => s + inv.paid, 0);
      const rem = tot - paid;
      const rows = cust.invoices.map(inv => `
        <tr>
          <td>${inv.date}</td><td>${inv.description}</td><td>${inv.quantity}</td>
          <td>${inv.unitPrice}</td><td>${inv.total}</td><td>${inv.paid}</td><td>${inv.remaining}</td>
        </tr>`).join('');
      let html = `
        <div style="font-family: 'Tajawal'; padding:20px; direction:rtl;">
          <h2 style="text-align:center;">Ù…Ø·Ø¨Ø¹Ø© Ø·Ø§Ø±Ù‚ Ø£Ø¨ÙˆÙ‡Ù…Ø§Ù…</h2>
          <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
          <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${cust.name}</p>
          <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${cust.phone}</p>
          <h3>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
          <table style="width:100%; border-collapse:collapse; border:1px solid #ccc;">
            <thead><tr style="background:#0d3b66; color:white;">
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ù…ØªØ¨Ù‚ÙŠ</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <div style="margin-top:20px;">
            <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${tot}</p>
            <p><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paid}</p>
            <p><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${rem}</p>
          </div>
        </div>
      `;
      document.getElementById("invoicePrint").innerHTML = html;
      setTimeout(() => {
        if (typeof html2pdf !== 'undefined') {
          html2pdf().from(document.getElementById("invoicePrint")).set({
            margin: 0.5,
            jsPDF: { format: 'a4' }
          }).save(`ÙÙˆØ§ØªÙŠØ±-${cust.name}.pdf`);
        } else {
          showToast("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ PDF.", "error");
        }
      }, 300);
      showToast("ØªÙ… ØªØµØ¯ÙŠØ± PDF Ø¨Ù†Ø¬Ø§Ø­");
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Firebase)
    function editCustomer(key) {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      if (!firebaseInitialized) {
        showToast("Firebase ØºÙŠØ± Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… editCustomerLocal.", "error");
        return;
      }
      const newPhone = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", data[key].phone);
      if (newPhone && newPhone.trim()) {
        customersRef.child(key).update({ phone: newPhone.trim() })
          .then(() => showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ù†Ø¬Ø§Ø­"))
          .catch((error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", error);
            showToast("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Firebase. Ø¬Ø±Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§.", "error");
          });
      } else {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­", "error");
      }
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø­Ù„ÙŠ)
    function editCustomerLocal(index) {
      if (firebaseInitialized) {
        showToast("Firebase Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… editCustomer.", "error");
        return;
      }
      const newPhone = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", data[index].phone);
      if (newPhone && newPhone.trim()) {
        data[index].phone = newPhone.trim();
        saveData();
        renderCustomers();
        showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ù†Ø¬Ø§Ø­");
      } else {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­", "error");
      }
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ JSON
    function exportData() {
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `customers_data_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showToast("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† JSON
    function importData(event) {
      if (!currentUser && firebaseInitialized) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          data = JSON.parse(e.target.result);
          if (firebaseInitialized) {
            customersRef.set(data)
              .then(() => {
                showToast("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
                renderCustomers();
              })
              .catch((error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", error);
                localStorage.setItem("customersData", JSON.stringify(data));
                renderCustomers();
                showToast("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Firebase.", "error");
              });
          } else {
            saveData();
            renderCustomers();
            showToast("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
          }
        } catch (err) {
          showToast("Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message, "error");
        }
      };
      reader.readAsText(file);
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    function renderGeneralStats() {
      const total = Object.values(data).reduce((sum, cust) => sum + (cust.invoices || []).filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„").reduce((s, inv) => s + (inv.total || 0), 0), 0);
      const paid = Object.values(data).reduce((sum, cust) => sum + (cust.invoices || []).filter(inv => inv.description !== "Ø¯ÙØ¹Ø© ØªØ­ØµÙŠÙ„").reduce((s, inv) => s + (inv.paid || 0), 0), 0);
      const remaining = total - paid;
      document.getElementById("generalStats").innerHTML = `
        <div><i class="fas fa-coins"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total || 0}</div>
        <div><i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${paid || 0}</div>
        <div><i class="fas fa-hourglass-half"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining || 0}</div>
      `;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    window.onload = function() {
      renderCustomers();
    };
  </script>
</body>
</html>
